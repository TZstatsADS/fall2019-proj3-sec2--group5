---
title: "XGBoost"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(xgboost)
library(caret)
library(dplyr)
library(MASS)
```

### Train

```{r}
source("../lib/xgb_train.R")
source("../lib/xgb_test.R")
source("../lib/xgb_cv.R")
source("../lib/xgb_tune.R")
source("../lib/xgb_accuracy.R")
source("../lib/ac_byclass.R")

#Reduced generated dataset
load(file="../output/dat_train_reduced.RData")
load(file="../output/dat_test_reduced.RData")

```

```{r}
load(file="../output/best_par_xgb.RData")
tm.xgb.reduced <- system.time( xgb.reduced <- xgb_train(dat_train_reduced, par = best_par_xgb))
ac.xgb.reduced <- xgb_accuracy(xgb.reduced, testdata = dat_test_reduced, testlabel = dat_test_reduced$emotion_idx)

ac.xgb.reduced.class <- ac_byclass(ac.xgb.reduced)
ac.xgb.reduced.class
```

### SVM

```{r}
source("../lib/train_SVM.R")
source("../lib/test_SVM.R")

tm.svm.reduced <- system.time(svm.reduced <- svm_train(dat_train_reduced, probability = TRUE, cost = 0.005))
svm.reduced.pred <- svm_test(svm.reduced, dat_test_reduced)
ac.svm.reduced <- mean(svm.reduced.pred==dat_test_reduced$emotion_idx)
ac.svm.reduced
ac.svm.reduced.class <- ac_byclass(confusionMatrix(svm.reduced.pred, dat_test_reduced$emotion_idx)$table)
ac.svm.reduced.class
```


```{r}
### stacking
source("../lib/stacking.R")
tm.stack <- system.time(stack <- stacking(xgb.reduced, svm.reduced, testdata = dat_test_reduced, coef = c(0.5, 0.5)))
ac.stack <- stack$overall[1]
ac.stack.class <- ac_byclass(stack$table)
```



```{r eval=F}
time.reduced <- c(tm.xgb.reduced[1], tm.svm.reduced[1], tm.stack[1])
ac.reduced <- c(ac.xgb.reduced$overall[1], ac.svm.reduced, ac.stack)
type <- c("xgb", "svm", "stacking")
performance.reduced <- data.frame(type, time.reduced, ac.reduced)
ac.class.reduced <- as.data.frame(rbind(ac.xgb.reduced.class, ac.svm.reduced.class, ac.stack.class))
ac.class.reduced$type<- type
performance.reduced <- left_join(performance.reduced, ac.class.reduced, by="type")
colnames(performance.reduced) <- c("model_type", "training_time", "overall_accuracy", label_names)
performance.reduced
```

### Tuning

```{r}
depth <- c(5,10, 15)
child <- c(3,5,10)
err.tune <- xgb_tune(dat_train_reduced, depth, child)
xgb.err.tune <- err.tune[1] %>% as.data.frame 
save(xgb.err.tune, file="../output/xgb.err.tune.RData")
best_par_xgb <- err.tune[2] %>% as.data.frame()
save(best_par_xgb, file="../output/best_par_xgb.RData")
```