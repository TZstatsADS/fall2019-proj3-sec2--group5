---
title: "XGBoost"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(xgboost)
library(caret)
library(dplyr)
```

### Train

```{r}
load("../output/feature_train.RData")
load("../output/feature_test.RData")

source("../lib/xgb_train.R")

model1 <- xgb_train(dat_train = dat_train, par = NULL)
```

### Test

```{r}
source("../lib/xgb_test.R")

xgb_test_pred <- xgb_test(model = model1, dat_test = dat_test, par = NULL) %>% as.data.frame() %>% mutate(prediction = max.col(., ties.method = "last")-1, label = test_label)

confusionMatrix(factor(xgb_test_pred$prediction), factor(xgb_test_pred$label), mode = "everything")

xgb_train_pred <- xgb_test(model = model1, dat_test = dat_train, par = NULL) %>% as.data.frame() %>% mutate(prediction = max.col(., ties.method = "last")-1, label = train_label)

confusionMatrix(factor(xgb_train_pred$prediction), factor(xgb_train_pred$label), mode = "everything")

xgb.save(model1, "xgb.model")
```





### Cross Validation

```{r}

source("../lib/xgb_cv.R")
      
cv.result <- xgb_cv(dat_train = dat_train, K=5, par = NULL)
cv.result
```




```{r}
#### TUNE ###
source("../lib/xgb_tune.R")

tune.result <- xgb_tune(dat_train = dat_train)
tune.result
cv_err <- as.data.frame(tune.result[1])
save(cv_err, file = "./cv_err.Rdata")
best_par <- as.data.frame(tune.result[2])
class(best_par)
save(best_par, file = "./best_par.Rdata")
```


```{r}
model_tuned <- xgb_train(dat_train = dat_train, par = best_par)

tuned_pred <- xgb_test(model = model_tuned, dat_test = dat_test, par = NULL) %>% as.data.frame() %>% mutate(prediction = max.col(., ties.method = "last")-1, label = test_label)

confusionMatrix(factor(tuned_pred$prediction), factor(tuned_pred$label), mode = "everything")

xgb.save(model_tuned, "xgb_tuned.model")
```
